# Change: Add Pentest Workflow Integration

## Status

| Phase | Progress | Notes |
|-------|----------|-------|
| Phase 1: Database Foundation | ✅ 100% | All records + 5/5 segments done |
| Phase 2: Port Health Check | ⏳ 0% | Ready to start |
| Phase 3: Vuln Correlation | ⏳ 0% | Has existing modules |
| Phase 3.5: MITRE ATT&CK + IOCs | ⏳ 0% | Expanded - Full threat intel framework |
| Phase 4: Exploit Planning | ⏳ 0% | Now integrated with ATT&CK |
| Phase 5: Playbooks | ✅ 100% | **DONE** - 11 playbooks, types + catalog |
| Phase 6: Shell Integration | ⏳ 0% | TUI exists |
| Phase 7: Documentation | ⏳ 0% | - |

**Last updated**: 2025-12-10

## Vision

**redblue aims to be the first single-binary offensive security tool that thinks like a red team.**

We combine:
1. **Our Strength**: Fast, accurate scanning (ports, DNS, TLS, subdomains, fingerprinting)
2. **MITRE ATT&CK**: Industry-standard technique framework for attack categorization
3. **Automation**: Playbooks that chain our tools following ATT&CK tactics flow

The result: A tool that not only finds vulnerabilities but **maps them to attack techniques** and **generates actionable attack plans**.

## Why

redblue has a powerful database engine (RedDB) that stores port scans, fingerprints, TLS audits, subdomains, and more. However, this data is currently siloed - users cannot leverage stored data to automate pentest workflows like:
- Re-verifying if discovered ports are still open
- Correlating detected technologies with known CVEs
- **Mapping findings to MITRE ATT&CK techniques (835 techniques, 14 tactics)**
- Planning attack strategies based on discovered vulnerabilities
- **Running ATT&CK-aligned playbooks for common pentest scenarios**
- **Exporting IOCs in STIX 2.1 format for threat intel sharing**

This change integrates the database with CLI/Shell to create a complete, automated pentest workflow engine that **thinks strategically like a red team operator**.

## What Changes

### 1. Port Health Check (`port-health-check`)
- **NEW** `rb network ports check <target>` - Re-scan saved ports, detect changes
- **NEW** `rb network ports diff <target>` - Show ports that opened/closed since last scan
- **NEW** `rb network ports watch <target>` - Continuous monitoring with alerts
- **NEW** `PortHealthRecord` - Track port state changes over time

### 2. Vulnerability Correlation (`vuln-correlation`)
- **NEW** `rb vuln correlate <target>` - Auto-correlate fingerprints → CVEs
- **NEW** `rb vuln scan <target>` - Full scan: fingerprint + CVE lookup
- **NEW** `rb vuln report <target>` - Generate vulnerability reports
- **NEW** `VulnerabilityRecord` - Store CVE data with risk scores
- **NEW** `FingerprintRecord` - Store detected technologies with CPE mapping

### 3.5. MITRE ATT&CK + IOCs (`threat-intel`) - EXPANDED

**Based on analysis of official MITRE ATT&CK repositories (attack-stix-data, attack-data-model, attack-navigator, attack-workbench-taxii-server)**

#### Core Philosophy: Bridge Our Scanning → ATT&CK Framework

Our scans produce raw data. ATT&CK provides strategic context:
- Port 22 open → **T1021.004** (Remote Services: SSH)
- nginx 1.18.0 CVE → **T1190** (Exploit Public-Facing Application)
- Subdomain takeover possible → **T1584.001** (Compromise Infrastructure)

#### 3.5.1 MITRE ATT&CK Database (Embedded)
- **Embed enterprise-attack.json** (~5MB compressed) into binary
- **835 techniques** (356 parent + 479 sub-techniques)
- **14 tactics**: reconnaissance, resource-development, initial-access, execution, persistence, privilege-escalation, defense-evasion, credential-access, discovery, lateral-movement, collection, command-and-control, exfiltration, impact
- **20,048 relationships** linking techniques to malware, groups, mitigations

#### 3.5.2 CLI Commands
```bash
# ATT&CK Technique Lookup
rb intel mitre search T1055              # Search by technique ID
rb intel mitre search "Process Injection" # Search by name
rb intel mitre technique T1059.001       # Full technique details
rb intel mitre group G0016               # Techniques used by APT group

# ATT&CK Mapping (Our Core Feature)
rb intel mitre map <target>              # Map all findings to techniques
rb intel mitre matrix <target>           # ASCII matrix view
rb intel mitre coverage <target>         # Show which tactics we detected

# Navigator Integration
rb intel mitre export <target> --format layer  # ATT&CK Navigator layer JSON
rb intel mitre import <layer.json>       # Import Navigator layer

# TAXII Client (Live Updates)
rb intel taxii sync                      # Sync from MITRE TAXII server
rb intel taxii collections               # List available collections

# IOC Management
rb intel ioc <target>                    # List extracted IOCs
rb intel ioc export <target> --format stix|csv|json
rb intel ioc import <file>               # Import external IOC feed
rb intel ioc search <value>              # Search IOC across all targets
```

#### 3.5.3 Automatic Technique Mapping

**Port → Technique Mapping**:
| Port | Service | Technique ID | Technique Name |
|------|---------|--------------|----------------|
| 22 | SSH | T1021.004 | Remote Services: SSH |
| 23 | Telnet | T1021 | Remote Services |
| 25 | SMTP | T1071.003 | Application Layer Protocol: Mail Protocols |
| 53 | DNS | T1071.004 | Application Layer Protocol: DNS |
| 80/443 | HTTP/S | T1071.001 | Application Layer Protocol: Web Protocols |
| 135 | RPC | T1021.003 | Remote Services: Distributed Component Object Model |
| 389/636 | LDAP | T1087.002 | Account Discovery: Domain Account |
| 445 | SMB | T1021.002 | Remote Services: SMB/Windows Admin Shares |
| 1433 | MSSQL | T1505.001 | Server Software Component: SQL Stored Procedures |
| 3306 | MySQL | T1505 | Server Software Component |
| 3389 | RDP | T1021.001 | Remote Services: Remote Desktop Protocol |
| 5432 | PostgreSQL | T1505 | Server Software Component |
| 5985/5986 | WinRM | T1021.006 | Remote Services: Windows Remote Management |

**CVE → Technique Mapping** (via MITRE's CVE-to-ATT&CK mappings):
| CVE Pattern | Primary Technique |
|-------------|-------------------|
| RCE (Remote Code Execution) | T1203 (Exploitation for Client Execution) |
| SQLi (SQL Injection) | T1190 (Exploit Public-Facing Application) |
| LFI/RFI | T1190 + T1059 (Command Execution) |
| XXE | T1059.007 (JavaScript) |
| SSRF | T1557 (Adversary-in-the-Middle) |
| Auth Bypass | T1078 (Valid Accounts) |
| Privilege Escalation | T1068 (Exploitation for Privilege Escalation) |

**Fingerprint → Technique Mapping**:
| Technology | Relevant Techniques |
|------------|---------------------|
| WordPress | T1190, T1505.003 (Web Shell) |
| Apache Struts | T1190, T1059.007 |
| Jenkins | T1190, T1059 (Command Execution) |
| Docker exposed | T1610 (Deploy Container) |
| Kubernetes | T1609, T1610, T1611 |
| AWS S3 | T1530 (Data from Cloud Storage) |

#### 3.5.4 TAXII 2.1 Client

Based on analysis of `attack-workbench-taxii-server`:

**TAXII Endpoints to Implement**:
```
GET  /collections/                           → List collections
GET  /collections/:id/objects/               → Get STIX objects
GET  /collections/:id/objects/?match[type]=attack-pattern → Filter by type
GET  /collections/:id/objects/?added_after=2024-01-01 → Get updates
```

**Default TAXII Servers**:
- `https://cti-taxii.mitre.org/` - Official MITRE ATT&CK TAXII
- Custom servers via `rb config set intel.taxii.server <url>`

#### 3.5.5 Navigator Layer Export

Compatible with official ATT&CK Navigator (attack-navigator repo):

```json
{
  "name": "redblue: example.com",
  "version": "4.4",
  "domain": "mitre-enterprise",
  "description": "Auto-generated from redblue scan",
  "techniques": [
    {
      "techniqueID": "T1190",
      "tactic": "initial-access",
      "score": 100,
      "color": "#ff6666",
      "comment": "nginx 1.18.0 - CVE-2021-23017 (CVSS 7.7)"
    },
    {
      "techniqueID": "T1021.004",
      "tactic": "lateral-movement",
      "score": 50,
      "color": "#ffcc00",
      "comment": "SSH open on port 22"
    }
  ],
  "gradient": {
    "colors": ["#ffffff", "#ff6666"],
    "minValue": 0,
    "maxValue": 100
  }
}
```

#### 3.5.6 New Data Structures

**From attack-data-model Zod schemas (canonical MITRE definitions)**:

```rust
/// MITRE ATT&CK Technique (based on technique.schema.ts)
pub struct AttackTechnique {
    pub id: String,                        // "attack-pattern--{uuid}"
    pub external_id: String,               // "T1059.001"
    pub name: String,                      // "PowerShell"
    pub description: String,
    pub tactics: Vec<String>,              // ["execution", "defense-evasion"]
    pub platforms: Vec<Platform>,          // [Windows, Linux, macOS]
    pub permissions_required: Option<Vec<Permission>>,
    pub effective_permissions: Option<Vec<Permission>>,
    pub defense_bypassed: Option<Vec<String>>,
    pub data_sources: Option<Vec<String>>, // "Process: Process Creation"
    pub detection: Option<String>,
    pub is_subtechnique: bool,
    pub parent_technique: Option<String>,  // For sub-techniques
    pub mitre_version: String,
    pub deprecated: bool,
}

/// Relationship types (from relationship.schema.ts)
pub enum RelationshipType {
    Uses,           // Group/Malware → Technique
    Mitigates,      // Mitigation → Technique
    SubtechniqueOf, // Technique → Technique
    Detects,        // DataComponent → Technique
    AttributedTo,   // Campaign → Group
    Targets,        // Technique → Asset
    RevokedBy,      // Any → Same type (versioning)
}

/// Threat Group (from group.schema.ts)
pub struct ThreatGroup {
    pub id: String,                        // "intrusion-set--{uuid}"
    pub external_id: String,               // "G0016"
    pub name: String,                      // "APT29"
    pub aliases: Vec<String>,              // ["Cozy Bear", "The Dukes"]
    pub description: String,
    pub techniques_used: Vec<String>,      // ["T1059.001", "T1071.001"]
}

/// MITRE ATT&CK mapping from our scan (Phase 3.5)
pub struct MitreAttackRecord {
    pub technique_id: String,              // "T1059.001"
    pub technique_name: String,            // "PowerShell"
    pub tactic: String,                    // "execution"
    pub target: String,                    // Target domain/IP
    pub source_finding: String,            // "port_scan:22", "cve:CVE-2021-44228"
    pub cve_id: Option<String>,            // Linked CVE if applicable
    pub confidence: u8,                    // 0-100
    pub score: u8,                         // For Navigator layer (0-100)
    pub detected_at: u32,
    pub evidence: String,                  // Human-readable explanation
}

/// Indicator of Compromise (Phase 3.5)
pub struct IocRecord {
    pub ioc_type: IocType,
    pub value: String,                     // The IOC value
    pub target: String,
    pub confidence: u8,                    // 0-100
    pub source: String,                    // "port_scan", "tls_cert", "dns"
    pub mitre_techniques: Vec<String>,     // Related T#### IDs
    pub tags: Vec<String>,                 // User tags
    pub first_seen: u32,
    pub last_seen: u32,
    pub stix_id: Option<String>,           // For STIX export
}

pub enum IocType {
    IPv4,
    IPv6,
    Domain,
    URL,
    Email,
    HashMD5,
    HashSHA1,
    HashSHA256,
    Certificate,                           // TLS cert fingerprint
    JA3,                                   // TLS client fingerprint
}
```

#### 3.5.7 IOC Extraction Points

**Automatic IOC extraction from our existing scans**:

| Source | IOC Type | Extraction |
|--------|----------|------------|
| Port Scan | IPv4/IPv6 | Target IP addresses |
| DNS Lookup | Domain, IPv4 | Resolved domains, A records |
| TLS Audit | Domain, Certificate | SANs, issuer domains, cert fingerprints |
| Subdomain Enum | Domain | Discovered subdomains |
| WHOIS | Email, Domain | Registrant emails, nameservers |
| Web Crawl | URL, Domain | Discovered URLs, external links |
| HTTP Headers | Domain | Redirect targets, CSP domains |

#### 3.5.8 STIX 2.1 Export Format

For IOC sharing with other tools (MISP, OpenCTI, etc.):

```json
{
  "type": "bundle",
  "id": "bundle--redblue-export",
  "objects": [
    {
      "type": "indicator",
      "id": "indicator--{uuid}",
      "created": "2024-01-15T10:30:00Z",
      "name": "Suspicious IP from port scan",
      "pattern": "[ipv4-addr:value = '192.168.1.100']",
      "pattern_type": "stix",
      "valid_from": "2024-01-15T10:30:00Z",
      "labels": ["malicious-activity"],
      "external_references": [
        {
          "source_name": "redblue",
          "description": "Detected during port scan"
        }
      ]
    }
  ]
}
```

#### 3.5.9 TAXII 2.1 Client Implementation Details

**Based on attack-workbench-taxii-server analysis:**

```rust
/// TAXII 2.1 Client (src/modules/intel/taxii-client.rs)
pub struct TaxiiClient {
    base_url: String,                // e.g., https://cti-taxii.mitre.org
    api_root: String,                // e.g., /api/v21/
    auth: Option<BasicAuth>,
    cache: Option<TaxiiCache>,
}

pub struct TaxiiQuery {
    collection_id: String,
    match_filters: Vec<MatchFilter>,  // type, id, version, spec_version
    added_after: Option<String>,      // ISO 8601 timestamp
    limit: u32,
    next: Option<String>,             // Pagination token
}

pub enum MatchFilter {
    Type(Vec<String>),       // match[type]=attack-pattern,malware
    Id(Vec<String>),         // match[id]=attack-pattern--uuid
    Version(Vec<String>),    // match[version]=first,last,2024-01-01
    SpecVersion(Vec<String>), // match[spec_version]=2.0,2.1
}

pub struct TaxiiResponse<T> {
    more: bool,
    next: Option<String>,
    objects: Vec<T>,
}

/// TAXII API endpoints to implement
impl TaxiiClient {
    /// GET /taxii2/ - Server discovery
    pub fn discover(&self) -> Result<TaxiiDiscovery, TaxiiError>;

    /// GET /{api-root}/ - Get API root info
    pub fn get_api_root(&self) -> Result<ApiRoot, TaxiiError>;

    /// GET /{api-root}/collections/ - List collections
    pub fn get_collections(&self) -> Result<Vec<TaxiiCollection>, TaxiiError>;

    /// GET /{api-root}/collections/{id}/objects/ - Query objects
    pub fn get_objects(&self, query: TaxiiQuery) -> Result<TaxiiResponse<StixObject>, TaxiiError>;

    /// GET /{api-root}/collections/{id}/manifest/ - Lightweight metadata
    pub fn get_manifest(&self, collection_id: &str) -> Result<TaxiiResponse<ManifestRecord>, TaxiiError>;
}
```

**HTTP Headers Required:**
```
Accept: application/taxii+json;version=2.1
Authorization: Basic base64(username:password)  // Optional
```

**Rate Limiting:** MITRE TAXII server limits to **10 requests per 10 minutes per IP**.
Implementation must cache aggressively and use `added_after` for incremental sync.

#### 3.5.10 Complete Rust Structs (from attack-data-model analysis)

**Core STIX Types:**

```rust
/// STIX object identifier: "type--UUIDv4"
#[derive(Clone, Debug, Eq, Hash, PartialEq)]
pub struct StixIdentifier(String);

impl StixIdentifier {
    pub fn object_type(&self) -> &str {
        self.0.split("--").next().unwrap_or("")
    }
    pub fn uuid(&self) -> &str {
        self.0.split("--").nth(1).unwrap_or("")
    }
}

/// Supported STIX object types
#[derive(Clone, Copy, Debug, Eq, PartialEq)]
pub enum StixObjectType {
    AttackPattern,      // attack-pattern (Techniques)
    Campaign,
    CourseOfAction,     // Mitigations
    Identity,
    IntrusionSet,       // Groups/APTs
    Malware,
    Tool,
    XMitreTactic,       // x-mitre-tactic
    XMitreDataSource,   // x-mitre-data-source
    XMitreDataComponent, // x-mitre-data-component
    XMitreAsset,        // x-mitre-asset (ICS)
    Relationship,
    MarkingDefinition,
}

/// ATT&CK domains
#[derive(Clone, Copy, Debug, Eq, PartialEq)]
pub enum AttackDomain {
    Enterprise,  // enterprise-attack
    Mobile,      // mobile-attack
    ICS,         // ics-attack
}

/// Supported platforms (from technique.schema.ts)
#[derive(Clone, Debug, Eq, PartialEq)]
pub enum AttackPlatform {
    Windows,
    Linux,
    MacOS,
    IOS,
    Android,
    Containers,
    ESXi,
    AzureAD,
    GoogleWorkspace,
    OfficeSuite,
    SaaS,
    IaaS,
    NetworkDevices,
    FieldController,  // ICS
    EngineeringWorkstation, // ICS
    ControlServer,    // ICS
    HumanMachineInterface, // ICS
}

/// Relationship types (from relationship.schema.ts)
#[derive(Clone, Copy, Debug, Eq, PartialEq)]
pub enum RelationshipType {
    Uses,           // malware/tool/group → technique
    Mitigates,      // mitigation → technique
    SubtechniqueOf, // technique → technique
    Detects,        // data-component → technique
    AttributedTo,   // campaign → group
    Targets,        // technique → asset
    RevokedBy,      // any → same type (versioning)
}

/// Valid relationship constraints (from relationship.schema.ts)
impl RelationshipType {
    pub fn valid_sources(&self) -> &[StixObjectType] {
        match self {
            Self::Uses => &[StixObjectType::Malware, StixObjectType::Tool,
                          StixObjectType::IntrusionSet, StixObjectType::Campaign],
            Self::Mitigates => &[StixObjectType::CourseOfAction],
            Self::SubtechniqueOf => &[StixObjectType::AttackPattern],
            Self::Detects => &[StixObjectType::XMitreDataComponent],
            Self::AttributedTo => &[StixObjectType::Campaign],
            Self::Targets => &[StixObjectType::AttackPattern],
            Self::RevokedBy => &[], // Same as source
        }
    }

    pub fn valid_targets(&self) -> &[StixObjectType] {
        match self {
            Self::Uses => &[StixObjectType::AttackPattern,
                          StixObjectType::Malware, StixObjectType::Tool],
            Self::Mitigates => &[StixObjectType::AttackPattern],
            Self::SubtechniqueOf => &[StixObjectType::AttackPattern],
            Self::Detects => &[StixObjectType::AttackPattern],
            Self::AttributedTo => &[StixObjectType::IntrusionSet],
            Self::Targets => &[StixObjectType::XMitreAsset],
            Self::RevokedBy => &[], // Same as source
        }
    }
}
```

**ATT&CK Object Structs:**

```rust
/// External reference (citations, ATT&CK IDs)
pub struct ExternalReference {
    pub source_name: String,
    pub external_id: Option<String>,  // T1059.001, G0016, etc.
    pub url: Option<String>,
    pub description: Option<String>,
}

/// Kill chain phase (tactic mapping)
pub struct KillChainPhase {
    pub kill_chain_name: String,  // "mitre-attack"
    pub phase_name: String,       // "execution", "initial-access"
}

/// Full ATT&CK Technique (from technique.schema.ts)
pub struct Technique {
    // STIX base
    pub id: StixIdentifier,           // attack-pattern--{uuid}
    pub spec_version: String,         // "2.1"
    pub created: String,              // ISO 8601
    pub modified: String,
    pub revoked: bool,
    pub external_references: Vec<ExternalReference>,

    // ATT&CK base
    pub name: String,
    pub description: Option<String>,
    pub x_mitre_attack_spec_version: String,  // "3.3.0"
    pub x_mitre_version: String,              // "2.5"
    pub x_mitre_deprecated: bool,

    // Technique-specific
    pub kill_chain_phases: Vec<KillChainPhase>,
    pub x_mitre_is_subtechnique: bool,
    pub x_mitre_domains: Vec<AttackDomain>,
    pub x_mitre_platforms: Option<Vec<AttackPlatform>>,
    pub x_mitre_data_sources: Option<Vec<String>>,      // "Process: Process Creation"
    pub x_mitre_detection: Option<String>,
    pub x_mitre_defense_bypassed: Option<Vec<String>>,
    pub x_mitre_permissions_required: Option<Vec<String>>, // User, Administrator, SYSTEM, root
    pub x_mitre_effective_permissions: Option<Vec<String>>,
    pub x_mitre_remote_support: Option<bool>,
    pub x_mitre_system_requirements: Option<Vec<String>>,
    pub x_mitre_impact_type: Option<Vec<String>>,       // Integrity, Availability
    pub x_mitre_network_requirements: Option<bool>,
    pub x_mitre_contributors: Option<Vec<String>>,
}

/// Threat Group / Intrusion Set (from group.schema.ts)
pub struct ThreatGroup {
    pub id: StixIdentifier,           // intrusion-set--{uuid}
    pub spec_version: String,
    pub created: String,
    pub modified: String,

    pub name: String,
    pub description: Option<String>,
    pub aliases: Vec<String>,         // First must match name
    pub x_mitre_domains: Vec<AttackDomain>,
    pub x_mitre_attack_spec_version: String,
    pub x_mitre_version: String,
    pub x_mitre_contributors: Option<Vec<String>>,

    // STIX intrusion-set fields
    pub first_seen: Option<String>,
    pub last_seen: Option<String>,
    pub goals: Option<Vec<String>>,
    pub resource_level: Option<String>,
    pub primary_motivation: Option<String>,
    pub secondary_motivations: Option<Vec<String>>,
}

/// Software (Malware or Tool) (from malware.schema.ts, tool.schema.ts)
pub struct Software {
    pub id: StixIdentifier,           // malware--{uuid} or tool--{uuid}
    pub object_type: StixObjectType,  // Malware or Tool
    pub spec_version: String,
    pub created: String,
    pub modified: String,

    pub name: String,
    pub description: Option<String>,
    pub x_mitre_platforms: Option<Vec<AttackPlatform>>,
    pub x_mitre_aliases: Option<Vec<String>>,
    pub x_mitre_domains: Vec<AttackDomain>,
    pub x_mitre_attack_spec_version: String,
    pub x_mitre_version: String,
    pub x_mitre_contributors: Option<Vec<String>>,

    // Malware-specific
    pub is_family: Option<bool>,      // malware only
    pub malware_types: Option<Vec<String>>, // malware only
}

/// Relationship (from relationship.schema.ts)
pub struct Relationship {
    pub id: StixIdentifier,           // relationship--{uuid}
    pub spec_version: String,
    pub created: String,
    pub modified: String,

    pub relationship_type: RelationshipType,
    pub source_ref: StixIdentifier,
    pub target_ref: StixIdentifier,
    pub description: Option<String>,
    pub external_references: Option<Vec<ExternalReference>>,
}

/// Data Source (from data-source.schema.ts)
pub struct DataSource {
    pub id: StixIdentifier,           // x-mitre-data-source--{uuid}
    pub name: String,
    pub description: String,
    pub x_mitre_collection_layers: Vec<String>, // Host, Network, Cloud Control Plane
    pub x_mitre_platforms: Option<Vec<AttackPlatform>>,
    pub x_mitre_domains: Vec<AttackDomain>,
}

/// Data Component (from data-component.schema.ts)
pub struct DataComponent {
    pub id: StixIdentifier,           // x-mitre-data-component--{uuid}
    pub name: String,
    pub description: String,
    pub x_mitre_data_source_ref: StixIdentifier, // Parent data source
    pub x_mitre_domains: Vec<AttackDomain>,
}

/// Navigator Layer format v4.4 (from attack-navigator)
pub struct NavigatorLayer {
    pub name: String,
    pub version: String,              // "4.4"
    pub domain: String,               // "mitre-enterprise"
    pub description: Option<String>,
    pub techniques: Vec<TechniqueAnnotation>,
    pub gradient: Gradient,
    pub legend_items: Option<Vec<LegendItem>>,
    pub metadata: Option<Vec<Metadata>>,
}

pub struct TechniqueAnnotation {
    pub technique_id: String,         // T1059.001
    pub tactic: Option<String>,       // execution (for sub-techniques in multiple tactics)
    pub score: Option<u8>,            // 0-100
    pub color: Option<String>,        // #ff6666
    pub comment: Option<String>,
    pub enabled: bool,
}

pub struct Gradient {
    pub colors: Vec<String>,          // ["#ffffff", "#ff6666"]
    pub min_value: u8,
    pub max_value: u8,
}
```

**Current ATT&CK Spec Version: 3.3.0** (from attack-data-model/ATTACK_SPEC_VERSION)

### 4. Exploit Planning (`exploit-planning`)
- **NEW** `rb exploit plan <target>` - Generate attack plan based on CVEs/techs
- **NEW** `rb exploit suggest <target>` - Suggest available exploits
- **NEW** `rb exploit chain <target>` - Show potential attack chains
- **NEW** `ExploitAttemptRecord` - Track exploitation attempts and results
- **MODIFIED** Attack plans now include MITRE ATT&CK technique IDs

### 5. Playbooks (`playbooks`) - IMPLEMENTED ✅

**Intelligent Playbook System**: Playbooks follow Red Team methodology with human-friendly interfaces.

> **CRITICAL DESIGN PRINCIPLE**: MITRE ATT&CK mappings are INTERNAL ONLY.
> Users never see technique IDs (T1234) in the interface. We use human-friendly
> names ("Reverse Shell Assessment", "Port Discovery") while maintaining internal
> mappings for correlation, reporting, and threat intel integration.

#### 5.1 Implementation Status

**Files Created**:
- `src/playbooks/mod.rs` - Module documentation and exports
- `src/playbooks/types.rs` - Complete type system (750+ lines)
- `src/playbooks/catalog.rs` - 11 built-in playbooks (1000+ lines)

#### 5.2 CLI Commands
```bash
rb playbook list                              # List available playbooks
rb playbook list --target web                 # Filter by target type
rb playbook list --risk medium                # Filter by risk level
rb playbook show <id>                         # Display playbook details
rb playbook run <id> <target>                 # Execute playbook
rb playbook run <id> <target> --dry-run       # Preview without execution
rb playbook run <id> <target> --intrusive     # Allow high-risk steps
```

#### 5.3 Playbook Structure

Each playbook follows the Red Team methodology structure:

```
╭─────────────────────────────────────────────────────────────╮
│  Playbook Structure                                         │
├─────────────────────────────────────────────────────────────┤
│  1. OBJECTIVE        What we're trying to achieve          │
│  2. PRE-CONDITIONS   What must be true before starting     │
│  3. ATTACK FLOW      Step-by-step execution phases         │
│  4. EVIDENCE         What artifacts indicate success       │
│  5. FAILED CONTROLS  Defenses that commonly miss this      │
│  6. VARIATIONS       Alternative approaches                │
│  7. KILL CHAIN       High-level phase mapping              │
╰─────────────────────────────────────────────────────────────╯
```

#### 5.4 Type System (from `src/playbooks/types.rs`)

```rust
/// Playbook phases (Red Team methodology, NOT MITRE tactics)
pub enum PlaybookPhase {
    Recon,              // Initial reconnaissance
    InitialAccess,      // Establishing access
    Execution,          // Running payloads
    Persistence,        // Maintaining access
    PrivilegeEscalation,
    DefenseEvasion,
    Discovery,
    LateralMovement,
    Collection,
    Exfiltration,
    Impact,
    Cleanup,
}

/// Target types
pub enum TargetType {
    Host, WebApp, Network, Domain, Cloud, Internal, Container, Api,
}

/// Risk levels (determines consent requirements)
pub enum RiskLevel {
    Passive,   // No direct interaction
    Low,       // Safe active probing
    Medium,    // Standard active testing
    High,      // May trigger alerts (requires --intrusive)
    Critical,  // Likely disruption (requires explicit consent)
}

/// Pre-condition for playbook execution
pub struct PreCondition {
    pub description: String,
    pub check: Option<String>,      // Script ID to run
    pub required: bool,
    pub notes: Option<String>,
}

/// Step in the attack flow
pub struct PlaybookStep {
    pub number: u8,
    pub phase: PlaybookPhase,
    pub name: String,               // Human-friendly: "Establish Reverse Shell"
    pub description: String,
    pub scripts: Vec<String>,       // Script IDs to execute
    pub commands: Vec<String>,      // rb commands to run
    pub manual_instructions: Option<String>,
    pub success_criteria: Vec<String>,
    pub on_failure: StepFailureAction,
    pub depends_on: Vec<u8>,
    pub timeout: Duration,
    #[doc(hidden)]
    pub mitre_technique: Option<String>,  // INTERNAL ONLY - never shown
}

/// Expected evidence from execution
pub struct ExpectedEvidence {
    pub description: String,
    pub location: String,
    pub indicators: Vec<String>,
    pub severity: FindingSeverity,
}

/// Controls that commonly fail to detect this attack
pub struct FailedControl {
    pub name: String,       // "Egress Filtering"
    pub reason: String,     // "Outbound HTTP allowed without inspection"
    pub remediation: String,
}
```

#### 5.5 Built-in Playbooks (11 Playbooks)

**User sees**: Human-readable names and descriptions
**Internal**: MITRE mappings for correlation (never exposed)

| ID | Name | Target | Risk | Steps |
|----|------|--------|------|-------|
| `reverse-shell-linux` | Reverse Shell Assessment (Linux) | Host | High | 6 |
| `reverse-shell-windows` | Reverse Shell Assessment (Windows) | Host | High | 4 |
| `webshell-upload` | Webshell Upload Assessment | WebApp | High | 4 |
| `web-app-assessment` | Web Application Security Assessment | WebApp | Medium | 7 |
| `external-footprint` | External Attack Surface Mapping | Domain | Passive | 7 |
| `ssh-credential-test` | SSH Credential Testing | Host | High | 3 |
| `linux-privesc` | Linux Privilege Escalation Assessment | Host | Medium | 7 |
| `windows-privesc` | Windows Privilege Escalation Assessment | Host | Medium | 5 |
| `internal-recon` | Internal Network Reconnaissance | Internal | Medium | 5 |
| `lateral-movement` | Lateral Movement Assessment | Internal | High | 3 |
| `credential-harvesting` | Credential Harvesting Assessment | Host | High | 4 |

#### 5.6 Example Playbook: Reverse Shell (Linux)

```rust
// User sees this in `rb playbook show reverse-shell-linux`:
╭─────────────────────────────────────────────────────────────╮
│  Reverse Shell Assessment (Linux)                           │
│  ID: reverse-shell-linux                                    │
│  Risk: High (requires --intrusive flag)                     │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVE                                                  │
│  Validate network egress controls and endpoint detection    │
│  by attempting to establish outbound shell connections.     │
├─────────────────────────────────────────────────────────────┤
│  PRE-CONDITIONS                                             │
│  • Target system is reachable                               │
│  • Attack machine has listener capability                   │
│  • Authorization for testing confirmed                      │
├─────────────────────────────────────────────────────────────┤
│  ATTACK FLOW (6 steps)                                      │
│  1. [Recon] Target Port Analysis                            │
│     └─ rb network ports scan <target> --preset full         │
│  2. [Recon] Egress Path Discovery                           │
│     └─ rb network trace run <attacker-ip>                   │
│  3. [Access] Prepare Listener                               │
│     └─ rb exploit payload listener nc <port>                │
│  4. [Execution] Execute Shell Payload                       │
│     └─ rb exploit payload shell bash <ip> <port>            │
│  5. [Execution] Try Alternative Shells (optional)           │
│     └─ perl, python, php variants                           │
│  6. [Execution] Validate Shell Access                       │
│     └─ whoami, id, uname -a                                 │
├─────────────────────────────────────────────────────────────┤
│  EXPECTED EVIDENCE                                          │
│  • Network connection established (listener terminal)       │
│  • Command execution capability (shell session)             │
├─────────────────────────────────────────────────────────────┤
│  COMMON FAILED CONTROLS                                     │
│  • Egress Filtering - HTTP/HTTPS often allowed              │
│    Fix: Proxy-based egress with SSL inspection              │
│  • Endpoint Detection - Common interpreters not flagged     │
│    Fix: Behavioral analysis for command patterns            │
│  • Network Detection - Encrypted shells bypass signatures   │
│    Fix: TLS inspection + anomaly detection                  │
├─────────────────────────────────────────────────────────────┤
│  VARIATIONS                                                 │
│  • Encrypted Shell - Use when network monitoring present    │
│  • DNS Tunnel - Use when direct outbound is blocked         │
╰─────────────────────────────────────────────────────────────╯

// Note: MITRE technique IDs (T1059.004, T1071.001, etc.) are stored
// internally but NEVER displayed to the user.
```

#### 5.7 Internal MITRE Mapping (Developer Reference)

For correlation and reporting, each playbook step has internal MITRE tags:

```rust
// This is INTERNAL code - users never see these IDs
PlaybookStep::new(4, PlaybookPhase::Execution, "Execute Shell Payload")
    .with_description("Attempt to establish reverse shell connection")
    .with_command("rb exploit payload shell bash <ip> <port>")
    // Internal mapping (not shown in UI):
    .with_mitre("T1059.004", None)  // Unix Shell
```

This enables:
- **Correlation**: Link findings to threat intelligence
- **Coverage Analysis**: Track which techniques were tested
- **Navigator Export**: Generate ATT&CK layers (opt-in feature)
- **Reporting**: Include MITRE IDs when user explicitly requests

### 6. Shell Integration (`shell-integration`)
- **MODIFIED** `rb shell <target>` - Enhanced with database context
- **NEW** Quick commands in shell: `ports`, `vulns`, `check`, `watch`
- **NEW** Status bar showing target intel summary
- **NEW** `SessionRecord` - Track active shell sessions

## Impact

- **Affected specs**: `network-scanning`, `tls-audit`, `osint` (modifications)
- **New specs**: `port-health-check`, `vuln-correlation`, `exploit-planning`, `playbooks`, `shell-integration`
- **Affected code**:
  - `src/storage/records.rs` - New record types
  - `src/storage/segments/` - New segments for vulns, fingerprints, sessions
  - `src/cli/commands/` - New and modified commands
  - `src/cli/tui.rs` - Enhanced shell with database integration
  - `src/modules/recon/vuln/` - CVE correlation engine

## Dependencies

- Requires `implement-reddb-engine` change to be completed (36/49 tasks done)
- Builds on existing `add-vuln-intelligence` spec (vulnerability sources)
- Uses existing CPE dictionary in `src/modules/recon/vuln/cpe.rs`

## Risks

1. **Data volume**: CVE data can be large; mitigated by storing only relevant CVEs per target
2. **API rate limits**: NVD/OSV have rate limits; mitigated by caching and batch queries
3. **False positives**: Fingerprint-to-CVE mapping may have false positives; mitigated by confidence scores

## Success Criteria

1. User can run `rb network ports check` and see port state changes
2. User can run `rb vuln correlate` and get CVE list from stored fingerprints
3. User can run `rb exploit plan` and get actionable attack strategy
4. User can run `rb playbook run web-app-pentest example.com` for automated workflow
5. Shell shows real-time target intelligence and supports quick commands

## Data Schema Details

The following record structures will be implemented in `src/storage/records.rs`:

```rust
/// Vulnerability record from CVE correlation
pub struct VulnerabilityRecord {
    pub cve_id: String,           // e.g., "CVE-2021-44228"
    pub technology: String,       // e.g., "log4j"
    pub version: Option<String>,  // e.g., "2.14.0"
    pub cvss: f32,                // e.g., 10.0
    pub risk_score: u8,           // 0-100
    pub severity: Severity,       // Critical/High/Medium/Low
    pub description: String,
    pub references: Vec<String>,  // URLs
    pub exploit_available: bool,
    pub in_kev: bool,             // CISA Known Exploited
    pub discovered_at: u32,       // timestamp
    pub source: String,           // nvd/osv/kev/exploitdb
}

/// Fingerprint record from service detection
pub struct FingerprintRecord {
    pub host: String,
    pub port: u16,
    pub technology: String,       // e.g., "nginx"
    pub version: Option<String>,  // e.g., "1.21.0"
    pub cpe: Option<String>,      // e.g., "cpe:2.3:a:nginx:nginx:1.21.0"
    pub confidence: u8,           // 0-100
    pub source: String,           // banner/header/probe
    pub detected_at: u32,
}

/// Exploit attempt record
pub struct ExploitAttemptRecord {
    pub target: String,
    pub cve_id: Option<String>,
    pub exploit_name: String,
    pub status: ExploitStatus,    // Success/Failed/Pending
    pub output: Option<String>,
    pub attempted_at: u32,
}

/// Session record for active shells
pub struct SessionRecord {
    pub id: String,               // uuid
    pub target: String,
    pub shell_type: String,       // tcp/http/dns/icmp
    pub local_port: u16,
    pub remote_ip: String,
    pub status: SessionStatus,    // Active/Closed
    pub created_at: u32,
    pub last_activity: u32,
}

/// Playbook execution record
pub struct PlaybookRunRecord {
    pub playbook_name: String,
    pub target: String,
    pub status: PlaybookStatus,   // Running/Completed/Failed
    pub current_phase: u8,
    pub started_at: u32,
    pub completed_at: Option<u32>,
    pub results: Vec<StepResult>,
}

/// MITRE ATT&CK technique mapping (Phase 3.5)
pub struct MitreAttackRecord {
    pub technique_id: String,     // e.g., "T1059.001"
    pub technique_name: String,   // e.g., "PowerShell"
    pub tactic: String,           // e.g., "Execution"
    pub target: String,           // target domain/IP
    pub cve_id: Option<String>,   // linked CVE if any
    pub confidence: u8,           // 0-100
    pub detected_at: u32,         // timestamp
    pub evidence: String,         // why this technique was mapped
}

/// Indicator of Compromise record (Phase 3.5)
pub struct IocRecord {
    pub ioc_type: IocType,        // IP/Domain/Hash/URL/Email
    pub value: String,            // the actual IOC value
    pub target: String,           // associated target
    pub confidence: u8,           // 0-100
    pub source: String,           // port_scan/tls_audit/dns_lookup/etc.
    pub mitre_technique: Option<String>, // linked T#### if any
    pub tags: Vec<String>,        // custom tags
    pub first_seen: u32,          // timestamp
    pub last_seen: u32,           // timestamp
}

pub enum IocType {
    IP,
    Domain,
    Hash,      // MD5/SHA1/SHA256
    URL,
    Email,
}
```
