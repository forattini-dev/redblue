# Vulnerability Correlation Capability

## ADDED Requirements

### Requirement: Technology Fingerprint Storage
The system SHALL store detected technologies with CPE identifiers for CVE correlation.

#### Scenario: Store fingerprint from HTTP headers
- **WHEN** system detects technology from HTTP response (Server, X-Powered-By headers)
- **THEN** system creates FingerprintRecord with:
  - Host and port
  - Technology name and version
  - CPE identifier (mapped from technology)
  - Confidence score (0-100)
  - Source: "header"
  - Raw header value
  - Detection timestamp

#### Scenario: Store fingerprint from TLS
- **WHEN** system detects technology hints from TLS handshake
- **THEN** system creates FingerprintRecord with source: "tls"

#### Scenario: Store fingerprint from service banner
- **WHEN** system detects technology from service banner
- **THEN** system creates FingerprintRecord with source: "banner"

### Requirement: CVE Correlation Pipeline
The system SHALL correlate stored fingerprints with known CVEs from multiple sources.

#### Scenario: Correlate target fingerprints
- **WHEN** user runs `rb vuln correlate <target>`
- **THEN** system loads fingerprints from database for target
- **AND** maps each technology to CPE identifier
- **AND** queries vulnerability sources in parallel:
  - NVD (NIST National Vulnerability Database)
  - OSV (Open Source Vulnerabilities) for package ecosystems
  - KEV (CISA Known Exploited Vulnerabilities)
  - Exploit-DB for public exploits
- **AND** deduplicates results by CVE-ID
- **AND** calculates risk score for each vulnerability
- **AND** stores results in VulnSegment
- **AND** displays sorted results by risk score

#### Scenario: No fingerprints available
- **WHEN** user runs `rb vuln correlate <target>` with no stored fingerprints
- **THEN** system displays "No fingerprints found. Run 'rb web asset headers' or 'rb network ports scan' first."

### Requirement: Risk Score Calculation
The system SHALL calculate a risk score (0-100) for each vulnerability.

#### Scenario: Calculate risk score
- **WHEN** vulnerability is processed through correlation pipeline
- **THEN** system calculates risk score using formula:
  - Base: CVSS score Ã— 10 (0-100)
  - KEV bonus: +30 if in CISA Known Exploited list
  - Exploit bonus: +25 if public exploit available
  - Age factor: +5 for vulnerabilities disclosed in last 90 days
  - Impact factor: +5 for RCE/privilege escalation types
- **AND** caps final score at 100

#### Scenario: Display risk severity
- **WHEN** displaying vulnerability list
- **THEN** system shows color-coded severity:
  - ðŸ”´ Critical (risk 90-100)
  - ðŸŸ  High (risk 70-89)
  - ðŸŸ¡ Medium (risk 40-69)
  - ðŸŸ¢ Low (risk 0-39)

### Requirement: Full Vulnerability Scan
The system SHALL support combined fingerprinting and CVE correlation.

#### Scenario: Full vulnerability scan
- **WHEN** user runs `rb vuln scan <target>`
- **THEN** system performs:
  1. Port scan (if no stored ports)
  2. HTTP header analysis on web ports
  3. TLS audit on HTTPS ports
  4. Service banner grabbing
  5. Fingerprint storage
  6. CVE correlation
- **AND** displays comprehensive vulnerability report

### Requirement: Vulnerability Report Generation
The system SHALL generate vulnerability reports in multiple formats.

#### Scenario: Generate HTML report
- **WHEN** user runs `rb vuln report <target> --format html`
- **THEN** system generates HTML report with:
  - Executive summary with risk counts
  - Technology inventory table
  - Vulnerability details with CVE links
  - Remediation recommendations
- **AND** saves to file or outputs to stdout

#### Scenario: Generate JSON report
- **WHEN** user runs `rb vuln report <target> --format json`
- **THEN** system outputs JSON with full vulnerability data

### Requirement: Vulnerability Data Persistence
The system SHALL persist vulnerability data in the database.

#### Scenario: Store vulnerability record
- **WHEN** CVE is discovered through correlation
- **THEN** system stores VulnerabilityRecord with:
  - CVE ID
  - Associated technology and version
  - CVSS score and severity
  - Risk score (calculated)
  - Description
  - Reference URLs
  - Exploit availability flag
  - KEV status flag
  - Discovery timestamp
  - Source (nvd/osv/kev/exploitdb)

#### Scenario: Query stored vulnerabilities
- **WHEN** user runs `rb vuln list <target>`
- **THEN** system displays stored vulnerabilities without re-querying APIs
