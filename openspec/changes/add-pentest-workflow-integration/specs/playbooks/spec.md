# Playbooks Capability

## ADDED Requirements

### Requirement: Playbook Definition Format
The system SHALL support YAML-based playbook definitions for automated security workflows.

#### Scenario: Parse playbook file
- **WHEN** system loads playbook from `~/.redblue/playbooks/<name>.yaml`
- **THEN** system parses YAML structure with:
  - Metadata (name, description, version, author)
  - Variables (user-defined with defaults)
  - Phases (ordered execution groups)
  - Steps (individual commands within phases)
  - Conditions (execution predicates)

#### Scenario: Invalid playbook format
- **WHEN** playbook YAML is malformed or missing required fields
- **THEN** system displays validation error with line number and field name

### Requirement: Playbook Listing
The system SHALL list available playbooks from built-in and user directories.

#### Scenario: List all playbooks
- **WHEN** user runs `rb playbook list`
- **THEN** system displays table with:
  - Playbook name
  - Description
  - Phase count
  - Source (built-in / user)
- **AND** lists built-in playbooks first, then user playbooks

#### Scenario: No user playbooks
- **WHEN** user has no custom playbooks in `~/.redblue/playbooks/`
- **THEN** system displays only built-in playbooks

### Requirement: Playbook Details
The system SHALL display detailed playbook information.

#### Scenario: Show playbook details
- **WHEN** user runs `rb playbook show <name>`
- **THEN** system displays:
  - Full metadata (name, description, version, author)
  - Variables with default values
  - Phase breakdown with step counts
  - Estimated duration (based on step types)
  - Required permissions/authorizations

### Requirement: Playbook Execution
The system SHALL execute playbooks against specified targets.

#### Scenario: Run playbook
- **WHEN** user runs `rb playbook run <name> <target>`
- **THEN** system:
  1. Validates playbook exists
  2. Substitutes {target} variable
  3. Creates PlaybookRunRecord
  4. Executes phases in order
  5. Updates progress display
  6. Stores results in database
  7. Displays summary on completion

#### Scenario: Phase execution
- **WHEN** executing a playbook phase
- **THEN** system:
  - Checks phase condition (if any)
  - Executes steps sequentially (or in parallel if parallel: true)
  - Captures stdout/stderr from each step
  - Stores step results
  - Continues to next phase on success

#### Scenario: Step failure
- **WHEN** a playbook step fails (non-zero exit code)
- **THEN** system:
  - Logs failure details
  - Checks step's `on_failure` directive:
    - `continue` (default): proceed to next step
    - `abort`: stop playbook execution
    - `retry N`: retry step N times
  - Records failure in PlaybookRunRecord

#### Scenario: Manual step
- **WHEN** step has `manual: true` flag
- **THEN** system:
  - Displays step description
  - Waits for user confirmation (y/n/skip)
  - Proceeds based on user input

### Requirement: Playbook Variables
The system SHALL support variable substitution in playbook commands.

#### Scenario: Substitute built-in variables
- **WHEN** command contains {target}, {timestamp}, {date}
- **THEN** system substitutes:
  - {target} → target argument
  - {timestamp} → Unix timestamp
  - {date} → YYYY-MM-DD format
  - {time} → HH:MM:SS format
  - {playbook} → playbook name

#### Scenario: Substitute user variables
- **WHEN** command contains {varname} defined in variables section
- **THEN** system substitutes with user-defined value

#### Scenario: Override variable at runtime
- **WHEN** user runs `rb playbook run <name> <target> --var threads=500`
- **THEN** system overrides variable value for this execution

### Requirement: Playbook Conditions
The system SHALL support conditional execution of phases and steps.

#### Scenario: Evaluate condition
- **WHEN** phase has `condition: ports.open_count > 0`
- **THEN** system:
  - Evaluates condition against stored step results
  - Executes phase only if condition is true
  - Skips phase with log message if false

#### Scenario: Supported condition expressions
- **WHEN** evaluating conditions
- **THEN** system supports:
  - Numeric comparisons: `> < >= <= == !=`
  - Boolean: `true`, `false`
  - Step result references: `stepname.field`
  - Logical operators: `and`, `or`, `not`

### Requirement: Playbook Progress Display
The system SHALL display real-time execution progress.

#### Scenario: Display progress
- **WHEN** playbook is executing
- **THEN** system displays:
  - Current phase name and number (e.g., "Phase 2/5: Fingerprinting")
  - Current step and progress bar
  - Elapsed time
  - Step results as they complete (✅/❌)

#### Scenario: Verbose mode
- **WHEN** user runs with `--verbose` flag
- **THEN** system also displays command output in real-time

### Requirement: Playbook Dry Run
The system SHALL support dry run mode for playbook validation.

#### Scenario: Dry run execution
- **WHEN** user runs `rb playbook run <name> <target> --dry-run`
- **THEN** system:
  - Parses and validates playbook
  - Displays all commands that would execute (with variables substituted)
  - Does NOT execute any commands
  - Validates conditions are syntactically correct

### Requirement: Built-in Playbooks
The system SHALL include built-in playbooks for common security workflows.

#### Scenario: Web application pentest playbook
- **WHEN** user runs `rb playbook run web-app-pentest <target>`
- **THEN** system executes phases:
  1. Reconnaissance (subdomains, WHOIS, DNS)
  2. Fingerprinting (ports, headers, TLS)
  3. Vulnerability scan (CVE correlation)
  4. Exploitation (manual confirmation required)
  5. Reporting (HTML/JSON output)

#### Scenario: Linux privilege escalation playbook
- **WHEN** user runs `rb playbook run linux-privesc <target>`
- **THEN** system executes enumeration for:
  - SUID binaries
  - Sudo permissions
  - Cron jobs
  - Writable directories
  - Kernel version
  - Capabilities

#### Scenario: Subdomain takeover playbook
- **WHEN** user runs `rb playbook run subdomain-takeover <target>`
- **THEN** system executes:
  1. Subdomain enumeration
  2. CNAME resolution
  3. Takeover vulnerability check
  4. Proof of concept (if --exploit flag)

### Requirement: Playbook Creation
The system SHALL support creating custom playbooks.

#### Scenario: Create from template
- **WHEN** user runs `rb playbook create <name>`
- **THEN** system:
  - Creates `~/.redblue/playbooks/<name>.yaml`
  - Populates with template structure
  - Opens in $EDITOR (if set)
  - Displays creation confirmation

#### Scenario: Create interactively
- **WHEN** user runs `rb playbook create <name> --interactive`
- **THEN** system prompts for:
  - Description
  - Number of phases
  - Phase names and steps
  - Variables
  - Saves completed playbook

### Requirement: Playbook History
The system SHALL track playbook execution history.

#### Scenario: Store execution record
- **WHEN** playbook completes (success or failure)
- **THEN** system stores PlaybookRunRecord with:
  - Playbook name and version
  - Target
  - Final status
  - Start and end timestamps
  - All step results
  - Variable values used

#### Scenario: Query execution history
- **WHEN** user runs `rb playbook history [name]`
- **THEN** system displays recent executions with status and timestamps
