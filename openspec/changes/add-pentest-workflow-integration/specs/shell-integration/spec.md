# Shell Integration Capability

## ADDED Requirements

### Requirement: Database-Aware Shell Context
The system SHALL provide an enhanced shell with target-specific database context.

#### Scenario: Launch shell with target
- **WHEN** user runs `rb shell <target>`
- **THEN** system:
  - Enters full-screen TUI mode
  - Opens or creates database for target (`~/.redblue/targets/<target>.rbdb`)
  - Displays status bar with target intelligence summary
  - Shows prompt with target name: `redblue:<target>>`
  - Loads command history for this target

#### Scenario: Shell status bar
- **WHEN** shell is active
- **THEN** status bar displays:
  - Target name
  - Database path
  - Port count (N open)
  - Subdomain count
  - CVE count (with critical count highlighted)
  - Last scan timestamp (relative: "2m ago")

#### Scenario: Status bar refresh
- **WHEN** database content changes (via command or external modification)
- **THEN** status bar updates to reflect new counts

### Requirement: Shell Quick Commands
The system SHALL provide abbreviated commands for common operations within shell.

#### Scenario: Ports quick command
- **WHEN** user types `ports` in shell
- **THEN** system displays stored open ports table with:
  - Port number
  - Status (open/closed)
  - Service name
  - Last check timestamp

#### Scenario: Vulns quick command
- **WHEN** user types `vulns` in shell
- **THEN** system displays stored vulnerabilities table with:
  - CVE ID
  - Technology
  - Risk score (color-coded)
  - Description (truncated)

#### Scenario: Check quick command
- **WHEN** user types `check` in shell
- **THEN** system executes `rb network ports check <current_target>`
- **AND** displays port state diff
- **AND** updates status bar

#### Scenario: Watch quick command
- **WHEN** user types `watch` in shell
- **THEN** system starts port monitoring mode
- **AND** displays alerts on state changes
- **AND** user can exit with Escape or Ctrl+C

#### Scenario: Plan quick command
- **WHEN** user types `plan` in shell
- **THEN** system executes `rb exploit plan <current_target>`
- **AND** displays attack plan

#### Scenario: Run playbook quick command
- **WHEN** user types `run <playbook>` in shell
- **THEN** system executes `rb playbook run <playbook> <current_target>`
- **AND** displays progress within shell

### Requirement: Shell Command Execution
The system SHALL execute full rb commands within shell context.

#### Scenario: Execute rb command
- **WHEN** user types full rb command (e.g., `network ports scan --preset full`)
- **THEN** system:
  - Prepends target if not specified
  - Executes command
  - Captures output
  - Displays in scrollable pane
  - Updates status bar

#### Scenario: Execute external command
- **WHEN** user types command starting with `!` (e.g., `!ping example.com`)
- **THEN** system executes as shell command via system shell
- **AND** displays output

### Requirement: Shell Output History
The system SHALL maintain scrollable output history within shell.

#### Scenario: Scroll output
- **WHEN** command output exceeds visible area
- **THEN** user can scroll with:
  - Arrow keys (line by line)
  - Page Up/Down (page by page)
  - Home/End (top/bottom)

#### Scenario: Clear output
- **WHEN** user types `clear` or presses Ctrl+L
- **THEN** system clears output area
- **AND** status bar remains visible

### Requirement: Shell Command History
The system SHALL persist command history per target.

#### Scenario: Navigate history
- **WHEN** user presses Up/Down arrow at prompt
- **THEN** system cycles through previous commands for current target

#### Scenario: Search history
- **WHEN** user presses Ctrl+R
- **THEN** system enters reverse search mode
- **AND** user can type to filter history
- **AND** Enter executes selected command

#### Scenario: Persist history
- **WHEN** user exits shell
- **THEN** system saves command history to `~/.redblue/history/<target>`

### Requirement: Shell Help System
The system SHALL provide contextual help within shell.

#### Scenario: Show help overlay
- **WHEN** user types `help` or presses `?` or `F1`
- **THEN** system displays help overlay with:
  - Quick commands list
  - Keyboard shortcuts
  - Current target info

#### Scenario: Command completion help
- **WHEN** user presses Tab
- **THEN** system shows available completions:
  - Quick commands
  - Full rb commands
  - Recent commands

### Requirement: Shell Notifications
The system SHALL display notifications for important events.

#### Scenario: Port change notification
- **WHEN** port state changes during watch mode
- **THEN** system displays highlighted notification:
  - Timestamp
  - Port number
  - Old state → New state
  - Plays terminal bell (if enabled)

#### Scenario: Playbook completion notification
- **WHEN** playbook completes in background
- **THEN** system displays notification with status (✅/❌)

### Requirement: Shell Session Management
The system SHALL track active shell sessions.

#### Scenario: Store session record
- **WHEN** shell is launched
- **THEN** system creates SessionRecord with:
  - Session ID (UUID)
  - Target
  - Shell type (interactive)
  - Start timestamp

#### Scenario: Update session activity
- **WHEN** user executes command in shell
- **THEN** system updates last_activity timestamp

#### Scenario: Close session
- **WHEN** user exits shell (exit, quit, Ctrl+D)
- **THEN** system:
  - Updates SessionRecord status to Closed
  - Saves command history
  - Returns to normal terminal

### Requirement: Shell Theme
The system SHALL use consistent k9s-inspired theme.

#### Scenario: Apply theme colors
- **WHEN** shell is displayed
- **THEN** system uses color scheme:
  - Cyan: Headers, prompts
  - Orange: Warnings, highlights
  - Green: Success, running
  - Red: Errors, critical
  - Yellow: Medium severity
  - Blue: Info, links

#### Scenario: Respect terminal capabilities
- **WHEN** terminal does not support colors
- **THEN** system falls back to plain text mode
- **AND** uses ASCII indicators instead of emojis

### Requirement: Multi-Target Shell
The system SHALL support switching targets within shell.

#### Scenario: Switch target
- **WHEN** user types `target <new-target>` in shell
- **THEN** system:
  - Saves current session
  - Opens/creates database for new target
  - Updates prompt to `redblue:<new-target>>`
  - Updates status bar
  - Loads history for new target

#### Scenario: List targets
- **WHEN** user types `targets` in shell
- **THEN** system lists all targets with databases in `~/.redblue/targets/`
