use crate::storage::records::{VulnerabilityRecord, PortScanRecord, Severity};
use crate::modules::exploit::planner::{AttackOption, PlannerInput, generate_plan};

/// Suggest best exploits based on risk and success probability
pub fn suggest_exploits(input: PlannerInput) -> Vec<AttackOption> {
    // Generate the full plan first
    let plan = generate_plan(input);
    
    let mut all_options = Vec::new();

    // Flatten phases into a single list
    for phase in plan.phases {
        all_options.extend(phase.options);
    }

    // Rank options
    // Score = (Confidence * 0.6) + (Risk_Inverse * 0.4)
    // Risk_Inverse = 100 - Risk
    // High confidence + Low risk = Best score
    
    all_options.sort_by(|a, b| {
        let score_a = calculate_score(a);
        let score_b = calculate_score(b);
        score_b.cmp(&score_a) // Descending
    });

    all_options
}

fn calculate_score(option: &AttackOption) -> u32 {
    let confidence_score = (option.confidence as f32 * 0.6) as u32;
    let risk_score = ((100 - option.risk) as f32 * 0.4) as u32;
    confidence_score + risk_score
}

/// Get a specific rb command for an exploit if available
pub fn get_exploit_command(technique_id: &str, target: &str) -> Option<String> {
    match technique_id {
        "T1190" => Some(format!("rb vuln scan {}", target)),
        "T1021.004" => Some(format!("rb access shell create ssh://root@{}", target)),
        _ => None,
    }
}
